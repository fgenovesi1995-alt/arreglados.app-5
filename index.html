<!-- =========================
 ARREGLADOS – Frontend Pro
 Preparado para Vercel + Firebase
 ========================= -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Arreglados</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* === estilos intactos (los tuyos están muy bien) === */
body { background:#0d1117; color:#e6edf3; font-family:Inter,sans-serif }
.view { display:none }
.view.active { display:block }
.chat-bubble { padding:1rem 1.4rem;border-radius:1.5rem;margin-bottom:.8rem }
.chat-sent { background:#6366f1;color:white;align-self:flex-end }
.chat-received { background:#262c36 }
</style>
</head>

<body>
<div id="app-container">

<!-- =========================
 APP CONTENT (UI intacta)
 ========================= -->
<!-- ⚠️ UI OMITIDA AQUÍ POR BREVEDAD EN ESTA RESPUESTA ⚠️ -->
<!--
TU UI COMPLETA QUEDA IGUAL
NO CAMBIES NADA DE HTML VISUAL
-->

</div>

<!-- =========================
 LOGICA PROFESIONAL
 ========================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, query, where, limit, onSnapshot, getDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ======================
 CONFIG
 ====================== */
const firebaseConfig = JSON.parse(typeof __firebase_config !== "undefined" ? __firebase_config : "{}");
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ======================
 STATE
 ====================== */
let currentWorker = null;
let map = null;
let markers = [];

/* ======================
 AUTH
 ====================== */
signInAnonymously(auth);

onAuthStateChanged(auth, user => {
  fetchWorkers();
});

/* ======================
 MAP
 ====================== */
function initMap() {
  if (map) return;
  map = L.map("map").setView([-34.6037, -58.3816], 13);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);
}

/* ======================
 WORKERS (solo visibles)
 ====================== */
function fetchWorkers(category="all") {
  const col = collection(db,"workers");
  const q = category==="all"
    ? query(col, where("isVisible","==",true), limit(20))
    : query(col, where("isVisible","==",true), where("oficio","==",category));

  onSnapshot(q,snap=>{
    const list = document.getElementById("worker-list");
    list.innerHTML="";
    markers.forEach(m=>map && map.removeLayer(m));
    markers=[];

    snap.forEach(d=>{
      const w=d.data();
      const item=document.createElement("div");
      item.className="worker-item";
      item.textContent=`${w.nombre} – ${w.oficio}`;
      item.onclick=()=>openWorkerProfile(d.id);
      list.appendChild(item);

      if(map && w.lat && w.lng){
        const m=L.marker([w.lat,w.lng]).addTo(map);
        markers.push(m);
      }
    });
  });
}

/* ======================
 PROFILE
 ====================== */
async function openWorkerProfile(id){
  const snap=await getDoc(doc(db,"workers",id));
  if(!snap.exists()) return;
  currentWorker=snap.data();
  document.getElementById("worker-name-profile").textContent=currentWorker.nombre;
  document.getElementById("worker-oficio-profile").textContent=currentWorker.oficio;
  showView("worker-profile");
}

/* ======================
 CHAT (solo UI – backend después)
 ====================== */
window.sendMessage=()=>{
  const input=document.getElementById("chat-input");
  if(!input.value.trim()) return;
  const msg=document.createElement("div");
  msg.className="chat-bubble chat-sent";
  msg.textContent=input.value;
  document.getElementById("chat-messages").appendChild(msg);
  input.value="";
};

/* ======================
 NAV
 ====================== */
window.showView=(id)=>{
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.getElementById(id+"-view")?.classList.add("active");
};

</script>
</body>
</html>
