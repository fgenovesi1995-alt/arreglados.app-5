<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arreglados App - Oficios LATAM</title>
    
    <!-- Configuración PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#161b22">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=A">

    <!-- Dependencias: Tailwind, Leaflet (Mapas) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
     
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --bg-dark: #0d1117;
            --card-dark: #161b22;
            --border-dark: #30363d;
            --primary: #6366f1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark); 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: white;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 420px; 
            height: 94vh; 
            max-height: 850px;
            background-color: var(--card-dark); 
            border-radius: 2.8rem;
            box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border-dark);
        }

        /* Estilos de las vistas */
        .view {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 7rem;
            scrollbar-width: none;
        }
        .view::-webkit-scrollbar { display: none; }
        .view.active { display: block; }

        /* Estilos de Mapas */
        #map { 
            height: 350px; 
            width: 100%; 
            border-radius: 2rem; 
            z-index: 0; 
            margin-top: 1rem;
            border: 2px solid var(--border-dark);
        }
        
        /* Burbujas de Chat */
        .chat-bubble { 
            max-width: 80%; 
            padding: 0.9rem 1.3rem; 
            border-radius: 1.6rem; 
            margin-bottom: 0.8rem; 
            font-size: 0.9rem; 
            line-height: 1.5;
            animation: slideUp 0.3s ease-out;
        }
        .chat-sent { 
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); 
            color: white; 
            align-self: flex-end; 
            border-bottom-right-radius: 0.2rem; 
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .chat-received { 
            background-color: #30363d; 
            color: #f0f6fc; 
            align-self: flex-start; 
            border-bottom-left-radius: 0.2rem; 
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-view {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .nav-button.active { color: #6366f1; }
        .nav-button.active svg { stroke: #6366f1; }

        .cat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .cat-card.active {
            background-color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- HEADER GLOBAL -->
        <header class="p-6 bg-[#161b22]/90 backdrop-blur-md border-b border-gray-800 text-white flex justify-between items-center z-10">
            <h1 id="header-title" class="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">ARREGLADOS</h1>
            <div class="flex gap-4">
                <button id="map-toggle-btn" class="text-indigo-400 text-[10px] font-black uppercase tracking-widest bg-indigo-500/10 px-4 py-1.5 rounded-full hidden border border-indigo-500/20" onclick="window.toggleMapView()">
                    Mapa
                </button>
                <div class="relative cursor-pointer hover:scale-110 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    <span class="absolute -top-1 -right-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-grow relative bg-[#0d1117] overflow-hidden">

            <!-- VISTA: HOME / EXPLORAR -->
            <div id="home-view" class="view active p-6 animate-view">
                <div class="mb-8">
                    <h2 class="text-white text-3xl font-extrabold mb-1 tracking-tight">Busca ayuda</h2>
                    <p class="text-gray-500 text-sm mb-6">Expertos certificados cerca de ti.</p>
                    <div class="relative group">
                        <input type="text" placeholder="¿Qué necesitas arreglar?" 
                               class="w-full p-4 pl-12 rounded-2xl bg-[#161b22] text-white border border-gray-800 focus:outline-none focus:border-indigo-500 transition shadow-2xl group-hover:border-gray-700">
                        <svg class="absolute left-4 top-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                </div>

                <!-- GRILLA DE CATEGORÍAS CON ICONOS -->
                <div id="categories-grid" class="grid grid-cols-4 gap-3 mb-8">
                    <button class="cat-card flex flex-col items-center p-4 rounded-3xl bg-[#161b22] border border-gray-800 hover:border-indigo-500 transition shadow-lg" onclick="window.filterWorkers('Electricista')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mb-2 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2l-3 8h5l-3 10l5-8h-5l3-10z"/></svg>
                        <span class="text-[10px] font-black uppercase tracking-tighter">Luz</span>
                    </button>
                    <button class="cat-card flex flex-col items-center p-4 rounded-3xl bg-[#161b22] border border-gray-800 hover:border-indigo-500 transition shadow-lg" onclick="window.filterWorkers('Plomero')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mb-2 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v10m0 0l-4-4m4 4l4-4M5 20h14"/></svg>
                        <span class="text-[10px] font-black uppercase tracking-tighter">Agua</span>
                    </button>
                    <button class="cat-card flex flex-col items-center p-4 rounded-3xl bg-[#161b22] border border-gray-800 hover:border-indigo-500 transition shadow-lg" onclick="window.filterWorkers('Carpintero')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mb-2 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M6 20V4"/><path d="M12 14l6-6M8 8l4 4"/></svg>
                        <span class="text-[10px] font-black uppercase tracking-tighter">Madera</span>
                    </button>
                    <button class="cat-card flex flex-col items-center p-4 rounded-3xl bg-[#161b22] border border-gray-800 hover:border-indigo-500 transition shadow-lg" onclick="window.filterWorkers('all')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mb-2 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12h8m-4-4v8"/></svg>
                        <span class="text-[10px] font-black uppercase tracking-tighter">Más</span>
                    </button>
                </div>

                <!-- MAP CONTAINER -->
                <div id="map-container" class="hidden mb-8 animate-view">
                    <div id="map"></div>
                    <p class="text-[10px] text-gray-500 mt-2 text-center font-bold uppercase tracking-widest">Ubicación aproximada de profesionales</p>
                </div>

                <!-- LISTADO DE TRABAJADORES -->
                <div id="worker-list-container">
                    <h3 id="list-title" class="text-white text-xs font-black uppercase tracking-[0.2em] mb-6 flex items-center gap-3">
                        <span class="w-2.5 h-2.5 bg-indigo-500 rounded-full shadow-[0_0_10px_rgba(99,102,241,0.6)]"></span> Profesionales Cerca
                    </h3>
                    <div id="worker-list" class="space-y-5">
                        <!-- Esqueleto de carga visual -->
                        <div class="animate-pulse flex space-x-4 p-5 bg-[#161b22] rounded-[2.2rem] border border-gray-800">
                            <div class="rounded-2xl bg-gray-800 h-14 w-14"></div>
                            <div class="flex-1 space-y-3 py-1">
                                <div class="h-3 bg-gray-800 rounded w-3/4"></div>
                                <div class="h-2 bg-gray-800 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA: PERFIL DETALLADO PROFESIONAL -->
            <div id="worker-profile-view" class="view p-0 animate-view">
                <div class="relative h-60 bg-gradient-to-br from-indigo-900 via-indigo-800 to-fuchsia-900 p-8 flex items-end overflow-hidden">
                    <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
                    <button onclick="window.showView('home')" class="absolute top-8 left-8 p-3 bg-black/40 rounded-2xl text-white backdrop-blur-xl border border-white/10 shadow-2xl z-10 hover:bg-black/60 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    
                    <div class="flex items-center gap-6 translate-y-12 z-10">
                        <img id="worker-avatar-profile" class="h-28 w-28 rounded-[2.5rem] border-[10px] border-[#0d1117] object-cover bg-gray-800 shadow-2xl" src="">
                        <div class="mb-6">
                            <h2 id="worker-name-profile" class="text-3xl font-black text-white leading-none mb-2 tracking-tighter">...</h2>
                            <div class="flex items-center gap-2">
                                <p id="worker-oficio-profile" class="text-indigo-400 font-black uppercase tracking-[0.2em] text-[10px]">...</p>
                                <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                                <p class="text-yellow-400 text-xs font-bold">★ 4.9</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-8 mt-16 space-y-10">
                    <!-- Tarjeta de Stats Pro -->
                    <div class="grid grid-cols-3 gap-4 bg-[#161b22] p-6 rounded-[2.5rem] text-center border border-gray-800 shadow-2xl">
                        <div>
                            <p class="text-white font-black text-xl" id="worker-rating-val">4.9</p>
                            <p class="text-[9px] text-gray-600 uppercase font-black tracking-widest">Rating</p>
                        </div>
                        <div class="border-x border-gray-800 px-4">
                            <p class="text-white font-black text-xl" id="worker-distance-profile">... km</p>
                            <p class="text-[9px] text-gray-600 uppercase font-black tracking-widest">Distancia</p>
                        </div>
                        <div>
                            <p class="text-white font-black text-xl" id="worker-reviews-count">--</p>
                            <p class="text-[9px] text-gray-600 uppercase font-black tracking-widest">Reseñas</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-white font-black text-xs uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                            <div class="p-1.5 bg-indigo-500/20 rounded-lg text-indigo-400">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            </div> Biografía Profesional
                        </h3>
                        <p id="worker-bio-profile" class="text-gray-400 text-sm leading-relaxed font-medium">
                            Cargando información del experto verificado...
                        </p>
                    </div>

                    <div class="flex flex-col gap-4">
                        <button onclick="window.startChatFromProfile()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-[1.8rem] shadow-2xl shadow-indigo-500/30 active:scale-95 transition-all uppercase tracking-widest text-[11px]">INICIAR CONVERSACIÓN</button>
                        <button class="w-full py-4 bg-[#21262d] text-gray-300 font-bold rounded-[1.8rem] border border-gray-800 active:scale-95 transition-all text-[10px] uppercase tracking-widest">PEDIR PRESUPUESTO</button>
                    </div>
                </div>
            </div>

            <!-- VISTA: MENSAJES / CHATS -->
            <div id="messages-view" class="view p-6 animate-view">
                <h2 class="text-white text-4xl font-black tracking-tighter mb-10">Chats</h2>
                <div id="message-list" class="space-y-5">
                    <div class="bg-[#161b22] p-12 rounded-[3rem] border-2 border-dashed border-gray-800 text-center shadow-inner">
                        <div class="w-20 h-20 bg-gray-800/50 rounded-full flex items-center justify-center mx-auto mb-6 border border-gray-700 text-gray-600">
                            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </div>
                        <p class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-6 leading-relaxed">Debes iniciar sesión para<br>gestionar tus mensajes</p>
                        <button onclick="window.openAuthModal()" class="px-8 py-3 bg-indigo-500/10 text-indigo-400 rounded-full text-[10px] font-black uppercase tracking-widest border border-indigo-500/20 hover:bg-indigo-500/20 transition">Ir a Login</button>
                    </div>
                </div>
            </div>

            <!-- DETALLE DE CHAT INTERACTIVO -->
            <div id="chat-detail-view" class="absolute inset-0 bg-[#0d1117] z-30 hidden flex flex-col animate-view">
                <div class="p-4 bg-[#161b22]/95 backdrop-blur-xl border-b border-gray-800 flex items-center shadow-xl">
                    <button onclick="window.closeChat()" class="text-gray-400 mr-4 p-3 bg-gray-800/40 rounded-2xl hover:bg-gray-800 transition">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <img id="chat-avatar" class="h-12 w-12 rounded-2xl mr-4 object-cover border border-gray-700 shadow-lg" src="">
                    <div>
                        <h3 id="chat-name" class="text-white font-black text-sm tracking-tight">...</h3>
                        <p class="text-[9px] text-green-500 font-black uppercase tracking-widest mt-1 flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_10px_rgba(34,197,94,0.5)]"></span> Conectado
                        </p>
                    </div>
                </div>
                <div id="chat-messages" class="flex-grow p-6 overflow-y-auto flex flex-col bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
                    <!-- Burbujas dinámicas -->
                </div>
                <div class="p-4 bg-[#161b22] flex items-center border-t border-gray-800 shadow-[0_-15px_40px_rgba(0,0,0,0.5)]">
                    <button class="p-3.5 text-gray-500 hover:text-indigo-400 transition transform hover:scale-110"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></button>
                    <input id="chat-input" type="text" placeholder="Escribe tu mensaje..." class="flex-grow bg-[#0d1117] text-white rounded-[1.5rem] py-4 px-6 mx-2 focus:outline-none border border-gray-800 focus:border-indigo-500 transition-all font-semibold text-sm shadow-inner">
                    <button onclick="window.sendMessage()" class="bg-indigo-600 p-4 rounded-2xl text-white shadow-2xl shadow-indigo-500/40 active:scale-90 transition-all"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3.5"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg></button>
                </div>
            </div>

            <!-- VISTA: MIS TAREAS / TRABAJOS -->
            <div id="jobs-view" class="view p-6 animate-view">
                <h2 class="text-white text-4xl font-black tracking-tighter mb-10">Mis Tareas</h2>
                <div id="jobs-list" class="space-y-5">
                    <div class="bg-[#161b22] p-6 rounded-[2.8rem] border border-gray-800 shadow-2xl relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/5 rounded-full blur-2xl transition"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-white font-black text-base tracking-tight mb-1 uppercase">Reparación General</h4>
                                <p class="text-gray-600 text-[9px] font-black uppercase tracking-[0.2em]">ID #AR-2941</p>
                            </div>
                            <span class="px-4 py-1.5 bg-yellow-500/10 text-yellow-500 text-[9px] font-black rounded-full border border-yellow-500/20 uppercase tracking-widest shadow-lg">Pendiente</span>
                        </div>
                        <div class="flex items-center gap-4 py-4 border-y border-gray-800/40">
                            <div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400 font-black text-xs border border-indigo-500/20">W</div>
                            <div>
                                <p class="text-gray-300 text-xs font-black">Servicio Solicitado</p>
                                <p class="text-indigo-400 text-[9px] font-black uppercase tracking-widest mt-0.5">Pendiente de revisión</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-5">
                            <p class="text-gray-600 text-[9px] font-black uppercase tracking-widest">Hoy • 18:30</p>
                            <button class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.25em] hover:text-white transition flex items-center gap-2">GESTIONAR</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA: MI PERFIL / AJUSTES -->
            <div id="settings-view" class="view p-6 animate-view">
                <h2 class="text-white text-4xl font-black tracking-tighter mb-10">Mi Perfil</h2>
                <div id="auth-info" class="bg-gradient-to-br from-indigo-600 via-indigo-700 to-fuchsia-800 rounded-[2.8rem] p-8 mb-10 shadow-3xl shadow-indigo-900/40 relative overflow-hidden">
                    <div class="absolute -right-12 -top-12 w-48 h-48 bg-white/10 rounded-full blur-3xl"></div>
                    <!-- Dinámico con Auth -->
                </div>
                
                <div class="bg-[#161b22] rounded-[2.8rem] border border-gray-800 overflow-hidden divide-y divide-gray-800/50 shadow-2xl">
                    <div class="p-6 flex justify-between items-center text-white text-sm font-bold cursor-pointer hover:bg-gray-800 transition group">
                        <div class="flex items-center gap-5">
                            <div class="p-3 bg-gray-800 rounded-2xl text-indigo-400 shadow-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div>
                            <span class="tracking-tight uppercase text-xs font-black">Notificaciones</span>
                        </div>
                        <div class="w-12 h-6 bg-indigo-600 rounded-full relative shadow-inner"><div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full shadow-lg"></div></div>
                    </div>
                    <div id="sign-out-btn" class="p-6 flex items-center gap-5 text-red-400 text-sm font-black uppercase tracking-widest cursor-pointer hover:bg-red-900/10 transition hidden rounded-b-[2.8rem]" onclick="window.signOutUser()">
                        <div class="p-3 bg-red-900/20 rounded-2xl shadow-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></div>
                        <span>Cerrar Sesión</span>
                    </div>
                </div>
                <div class="mt-16 text-center">
                    <p class="text-gray-700 text-[10px] font-black uppercase tracking-[0.4em] mb-2">Arreglados Oficial v2.4.2</p>
                    <div class="flex justify-center gap-6 text-gray-800 text-[8px] font-bold uppercase tracking-widest">
                        <span>Privacidad</span>
                        <span>Soporte</span>
                        <span>TyC</span>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- MODAL AUTH -->
        <div id="auth-modal" class="fixed inset-0 bg-black/98 z-50 hidden justify-center items-center p-6 backdrop-blur-3xl">
            <div class="bg-[#161b22] p-10 rounded-[3.5rem] w-full max-w-sm border border-gray-800 shadow-2xl relative overflow-hidden">
                <div class="absolute -left-32 -bottom-32 w-80 h-80 bg-indigo-500/15 rounded-full blur-[100px]"></div>
                <div class="text-center mb-10 relative">
                    <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 via-purple-600 to-pink-500 rounded-[2rem] mx-auto mb-6 flex items-center justify-center text-white font-black text-4xl shadow-2xl shadow-indigo-500/30">A</div>
                    <h3 class="text-white text-3xl font-black tracking-tighter leading-none mb-2">Bienvenido</h3>
                    <p class="text-gray-500 text-[10px] font-black uppercase tracking-widest">Acceso Seguro</p>
                </div>
                
                <p id="auth-error-message" class="text-[10px] text-red-400 mb-6 hidden bg-red-950/30 p-4 rounded-2xl border border-red-900/50 text-center font-bold uppercase tracking-widest"></p>
                
                <div class="space-y-4 relative">
                    <input id="auth-email" type="email" placeholder="Correo Electrónico" class="w-full p-5 rounded-2xl bg-[#0d1117] text-white border border-gray-800 focus:border-indigo-500 transition-all outline-none font-bold placeholder:text-gray-700">
                    <input id="auth-password" type="password" placeholder="Contraseña" class="w-full p-5 rounded-2xl bg-[#0d1117] text-white border border-gray-800 focus:border-indigo-500 transition-all outline-none font-bold placeholder:text-gray-700">
                </div>

                <div class="mt-10 flex flex-col gap-4 relative">
                    <button id="login-button" onclick="window.handleAuth(true)" class="w-full py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-2xl shadow-indigo-500/30 active:scale-95 transition-all uppercase tracking-[0.2em] text-xs">Entrar</button>
                    <button id="register-button" onclick="window.handleAuth(false)" class="w-full py-5 bg-[#21262d] text-white font-black rounded-3xl border border-gray-800 active:scale-95 transition-all uppercase tracking-[0.2em] text-[10px]">Registrarse</button>
                </div>
                
                <button onclick="window.closeAuthModal()" class="w-full mt-8 text-gray-700 text-[11px] font-black uppercase tracking-[0.4em] hover:text-gray-500 transition-all">Cerrar</button>
            </div>
        </div>

        <!-- BARRA NAV INFERIOR -->
        <footer class="bg-[#161b22]/95 backdrop-blur-2xl border-t border-gray-800 p-2 flex justify-around items-center z-40 shadow-[0_-15px_50px_rgba(0,0,0,0.6)]">
            <button class="nav-button active flex flex-col items-center p-3 transition-all duration-300 transform" data-view="home" onclick="window.showView('home')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-[8px] font-black mt-2 uppercase tracking-tighter">Explorar</span>
            </button>
            <button class="nav-button flex flex-col items-center p-3 transition-all duration-300 text-gray-600 transform" data-view="messages" onclick="window.showView('messages')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <span class="text-[8px] font-black mt-2 uppercase tracking-tighter">Chats</span>
            </button>
            <button class="nav-button flex flex-col items-center p-3 transition-all duration-300 text-gray-600 transform" data-view="jobs" onclick="window.showView('jobs')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
                <span class="text-[8px] font-black mt-2 uppercase tracking-tighter">Tareas</span>
            </button>
            <button class="nav-button flex flex-col items-center p-3 transition-all duration-300 text-gray-600 transform" data-view="settings" onclick="window.showView('settings')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-[8px] font-black mt-2 uppercase tracking-tighter">Perfil</span>
            </button>
        </footer>
    </div>

    <!-- LÓGICA DE FIREBASE COMPLETA -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, limit, setDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN DE FIREBASE
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // INICIALIZACIÓN
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // REGISTRO GLOBAL (IMPORTANTE PARA HTML ONCLICK)
        window.currentWorkerData = null;
        window.markers = [];
        window.isAuthAppReady = false; 
        window.map = null;

        // --- NAVEGACIÓN ---
        window.showView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id === viewId + '-view'));
            document.querySelectorAll('.nav-button').forEach(btn => {
                const isActive = btn.dataset.view === viewId;
                btn.classList.toggle('text-indigo-400', isActive);
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('text-gray-600', !isActive);
            });
            
            const titles = { home: 'EXPLORAR', messages: 'MIS CHATS', jobs: 'MIS TAREAS', settings: 'MI CUENTA', 'worker-profile': 'PERFIL' };
            document.getElementById('header-title').textContent = titles[viewId] || 'ARREGLADOS';
            document.getElementById('map-toggle-btn').classList.toggle('hidden', viewId !== 'home');
            
            if (viewId === 'home' && window.map) {
                setTimeout(() => window.map.invalidateSize(), 150);
            }
        };

        // --- SISTEMA DE MAPAS (LEAFLET) ---
        window.toggleMapView = () => {
            const container = document.getElementById('map-container');
            const list = document.getElementById('worker-list-container');
            const btn = document.getElementById('map-toggle-btn');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                list.classList.add('hidden');
                btn.textContent = "Lista";
                if (!window.map) initMap();
                setTimeout(() => window.map.invalidateSize(), 200);
            } else {
                container.classList.add('hidden');
                list.classList.remove('hidden');
                btn.textContent = "Mapa";
            }
        };

        function initMap() {
            if (window.map) return;
            window.map = L.map('map', { zoomControl: false }).setView([-34.6037, -58.3816], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                attribution: '&copy; CartoDB',
                maxZoom: 19 
            }).addTo(window.map);
        }

        // --- AUTENTICACIÓN ---
        window.openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
        window.closeAuthModal = () => document.getElementById('auth-modal').classList.add('hidden');

        window.handleAuth = async (isLogin) => {
            if (!auth) return;
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error-message');
            
            if (!email || !password) return;
            errorEl.classList.add('hidden');

            try {
                if (isLogin) await signInWithEmailAndPassword(auth, email, password);
                else await createUserWithEmailAndPassword(auth, email, password);
                window.closeAuthModal();
            } catch (e) {
                console.error("Auth Error:", e);
                let cleanError = e.code ? e.code.split('/')[1].replace(/-/g, ' ') : 'Fallo en credenciales';
                errorEl.textContent = "FALLO: " + cleanError.toUpperCase();
                errorEl.classList.remove('hidden');
            }
        };

        window.signOutUser = () => signOut(auth);

        // --- GESTIÓN DE DATOS (WORKERS) ---
        window.filterWorkers = (category) => {
            document.getElementById('list-title').textContent = category === 'all' ? 'Destacados cerca de ti' : 'Resultados: ' + category;
            
            document.querySelectorAll('.cat-card').forEach(btn => {
                const isActive = btn.getAttribute('onclick').includes(category);
                btn.classList.toggle('active', isActive);
            });
            
            fetchWorkers(category);
        };

        let currentWorkersListener = null;

        function fetchWorkers(category = 'all') {
            if (!auth.currentUser) return;
            if (currentWorkersListener) currentWorkersListener();

            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'workers');
            let q = category === 'all' ? query(colRef, limit(12)) : query(colRef, where("oficio", "==", category));

            currentWorkersListener = onSnapshot(q, (snap) => {
                const container = document.getElementById('worker-list');
                container.innerHTML = snap.empty ? '<div class="p-16 text-center text-gray-700 font-black uppercase text-[10px] tracking-[0.4em]">Sin resultados en tu zona</div>' : '';
                
                if (window.map) window.markers.forEach(m => window.map.removeLayer(m));
                window.markers = [];

                snap.forEach(docSnap => {
                    const w = docSnap.data();
                    const initials = w.nombre ? w.nombre.split(' ').map(n => n[0]).join('') : 'W';
                    
                    container.innerHTML += `
                        <div class="flex items-center bg-[#161b22] p-6 rounded-[2.5rem] mb-4 border border-gray-800 hover:border-indigo-500 transition-all cursor-pointer shadow-xl active:scale-[0.98] group" onclick="window.openWorkerProfile('${docSnap.id}')">
                            <div class="h-16 w-16 rounded-[1.2rem] bg-indigo-900/40 text-indigo-400 flex items-center justify-center font-black text-2xl mr-6 border border-indigo-900/30 group-hover:scale-105 transition-transform">${initials}</div>
                            <div class="flex-grow">
                                <p class="text-white font-black text-sm tracking-tight mb-1">${w.nombre || 'Sin Nombre'}</p>
                                <p class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.2em] mt-0.5">${w.oficio || 'Profesional'}</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center justify-end gap-1 mb-1">
                                    <span class="text-yellow-400 text-xs font-black">★</span>
                                    <span class="text-white text-[10px] font-black">4.9</span>
                                </div>
                                <p class="text-gray-600 text-[9px] font-black uppercase tracking-widest">${w.distancia || 0} km</p>
                            </div>
                        </div>`;
                    
                    if (window.map && w.lat && w.lng) {
                        const m = L.marker([w.lat, w.lng]).addTo(window.map).bindPopup(`<b class="text-indigo-600">${w.nombre}</b><br><small>${w.oficio}</small>`);
                        window.markers.push(m);
                    }
                });
            }, (error) => {
                console.error("Firestore Error:", error);
            });
        }

        window.openWorkerProfile = async (id) => {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'workers', id);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const data = snap.data();
                window.currentWorkerData = data;
                
                document.getElementById('worker-name-profile').textContent = data.nombre || 'Sin Nombre';
                document.getElementById('worker-oficio-profile').textContent = data.oficio || 'Profesional';
                document.getElementById('worker-avatar-profile').src = `https://placehold.co/240x240/4f46e5/ffffff?text=${(data.nombre || 'W')[0]}`;
                document.getElementById('worker-distance-profile').textContent = (data.distancia || 0) + " km";
                document.getElementById('worker-reviews-count').textContent = Math.floor(Math.random() * 150) + 40;
                document.getElementById('worker-bio-profile').textContent = data.bio || `Soy ${data.nombre}, profesional certificado con años de experiencia en el rubro de ${data.oficio}. Ofrezco garantía total y presupuestos competitivos.`;
                
                window.showView('worker-profile');
            }
        };

        // --- SISTEMA DE CHAT ---
        window.startChatFromProfile = () => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                window.openAuthModal();
                return;
            }
            const name = window.currentWorkerData?.nombre || "Profesional";
            document.getElementById('chat-name').textContent = name;
            document.getElementById('chat-avatar').src = `https://placehold.co/100x100/6366f1/ffffff?text=${name[0]}`;
            
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = `
                <div class="chat-bubble chat-received animate-view">¡Hola! Soy ${name}. Vi que necesitas un experto en ${window.currentWorkerData?.oficio || 'el rubro'}. ¿Cómo puedo ayudarte?</div>
                <div class="chat-bubble chat-received animate-view">Puedo enviarte un presupuesto si me explicas un poco el problema.</div>
            `;
            
            document.getElementById('chat-detail-view').classList.remove('hidden');
        };

        window.closeChat = () => document.getElementById('chat-detail-view').classList.add('hidden');

        window.sendMessage = () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML += `<div class="chat-bubble chat-sent animate-view">${msg}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // Simulación respuesta
            setTimeout(() => {
                chatBox.innerHTML += `<div class="chat-bubble chat-received animate-view">Recibido. Dame un momento y te respondo con detalle.</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 1200);
        };

        // --- INICIALIZACIÓN (REGLA 3: AUTH PRIMERO) ---
        async function startApp() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                window.isAuthAppReady = true;
                await seedInitialData();
                fetchWorkers();
                
            } catch (err) {
                console.error("Critical Start Error:", err);
            }
        }

        async function seedInitialData() {
            if (!auth.currentUser) return;
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'workers');
            const snap = await getDocs(colRef);
            
            if (snap.empty) {
                const dummyData = [
                    { nombre: "Juan Pérez", oficio: "Electricista", distancia: 1.2, lat: -34.6037, lng: -58.3816 },
                    { nombre: "María Gómez", oficio: "Plomero", distancia: 2.5, lat: -34.5997, lng: -58.4000 },
                    { nombre: "Roberto Díaz", oficio: "Carpintero", distancia: 3.1, lat: -34.6200, lng: -58.3700 },
                    { nombre: "Ana López", oficio: "Electricista", distancia: 0.8, lat: -34.6150, lng: -58.3900 },
                    { nombre: "Carlos Tech", oficio: "Carpintero", distancia: 4.2, lat: -34.5800, lng: -58.4200 }
                ];
                for (const item of dummyData) {
                    await setDoc(doc(colRef, crypto.randomUUID()), item);
                }
            }
        }

        onAuthStateChanged(auth, (user) => {
            const infoContainer = document.getElementById('auth-info');
            const signoutBtn = document.getElementById('sign-out-btn');
            
            if (user && !user.isAnonymous) {
                // FIX: Verificamos si existe user.email antes de tomar la inicial [0]
                const emailChar = (user.email && user.email.length > 0) ? user.email[0].toUpperCase() : 'U';
                
                infoContainer.innerHTML = `
                    <div class="flex items-center gap-6 relative z-10">
                        <div class="w-18 h-18 bg-white/20 rounded-[1.5rem] flex items-center justify-center font-black text-3xl backdrop-blur-md border border-white/20 shadow-xl">${emailChar}</div>
                        <div>
                            <p class="text-white font-black text-2xl tracking-tighter leading-none mb-1">Mi Perfil</p>
                            <p class="text-indigo-100 text-[10px] font-bold uppercase tracking-widest opacity-80">${user.email || 'Usuario Logueado'}</p>
                        </div>
                    </div>`;
                signoutBtn.classList.remove('hidden');
                
                document.getElementById('message-list').innerHTML = `
                    <div class="bg-[#161b22] p-5 rounded-[2.5rem] border border-gray-800 flex items-center gap-4 cursor-pointer hover:border-indigo-500 transition-all shadow-lg active:scale-95" onclick="window.currentWorkerData={nombre:'Juan Pérez', oficio:'Electricista'}; window.startChatFromProfile()">
                        <div class="h-12 w-12 rounded-2xl bg-indigo-600 flex items-center justify-center font-black text-white text-xl shadow-lg">JP</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-1">
                                <h4 class="text-white font-bold text-sm">Juan Pérez</h4>
                                <span class="text-[9px] text-gray-600 font-bold uppercase">10:45 AM</span>
                            </div>
                            <p class="text-gray-500 text-xs font-medium truncate w-44">¿Te parece bien si paso mañana?</p>
                        </div>
                    </div>`;
            } else {
                infoContainer.innerHTML = `
                    <div class="relative z-10">
                        <h4 class="text-white font-black text-3xl tracking-tighter mb-4 leading-tight">Únete a la<br>comunidad</h4>
                        <p class="text-indigo-100 text-xs font-medium mb-8 opacity-90">Accede a presupuestos y chatea directamente con expertos.</p>
                        <button onclick="window.openAuthModal()" class="w-full py-4 bg-white text-indigo-700 font-black rounded-[1.5rem] shadow-2xl active:scale-95 transition-transform uppercase tracking-widest text-[10px]">CREAR MI CUENTA</button>
                    </div>`;
                signoutBtn.classList.add('hidden');
            }
            if (user) fetchWorkers();
        });

        startApp();
    </script>
</body>
</html>