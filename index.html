<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arreglados App - Oficios LATAM</title>
    
    <!-- Configuraci√≥n para Aplicaci√≥n Web Progresiva (PWA) -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#161b22">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/4f46e5/ffffff?text=A">

    <!-- Cargando Tailwind CSS para el dise√±o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cargando Leaflet para los mapas interactivos -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
     
    <style>
        /* Importaci√≥n de tipograf√≠a moderna */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --bg-dark: #0d1117;
            --card-dark: #161b22;
            --border-dark: #30363d;
            --primary: #6366f1;
            --secondary: #a855f7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark); 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: white;
            overflow: hidden; /* Evita scroll en el body fuera del contenedor de la app */
        }

        /* Contenedor principal estilo iPhone/M√≥vil */
        #app-container {
            width: 100%;
            max-width: 420px; 
            height: 92vh; 
            max-height: 850px;
            background-color: var(--card-dark); 
            border-radius: 2.8rem;
            box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border-dark);
        }

        /* Transiciones y visibilidad de las vistas */
        .view {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 7rem; /* Espacio para la navegaci√≥n inferior */
            scrollbar-width: none;
        }
        .view::-webkit-scrollbar { display: none; }
        .view.active { display: block; }

        /* Estilos personalizados para el mapa */
        #map { 
            height: 320px; 
            width: 100%; 
            border-radius: 2rem; 
            z-index: 0; 
            margin-top: 1rem;
            border: 2px solid var(--border-dark);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* Burbujas de chat estilizadas */
        .chat-bubble { 
            max-width: 82%; 
            padding: 1rem 1.4rem; 
            border-radius: 1.8rem; 
            margin-bottom: 1rem; 
            font-size: 0.95rem; 
            line-height: 1.5;
            position: relative;
            animation: slideUp 0.3s ease-out;
        }
        .chat-sent { 
            background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%); 
            color: white; 
            align-self: flex-end; 
            border-bottom-right-radius: 0.4rem; 
            box-shadow: 0 8px 16px rgba(99, 102, 241, 0.25);
        }
        .chat-received { 
            background-color: #21262d; 
            color: #e6edf3; 
            align-self: flex-start; 
            border-bottom-left-radius: 0.4rem; 
            border: 1px solid var(--border-dark);
        }

        /* Animaciones suaves */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-view { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Botones de categor√≠a */
        .cat-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .cat-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* Efecto de cristal para el header */
        .glass-header {
            background: rgba(22, 27, 34, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- HEADER GLOBAL CON EFECTO GLASS -->
        <header class="p-6 glass-header border-b border-gray-800 text-white flex justify-between items-center z-20">
            <div>
                <h1 id="header-title" class="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400">ARREGLADOS</h1>
            </div>
            <div class="flex gap-5 items-center">
                <button id="map-toggle-btn" class="text-indigo-400 text-[11px] font-black uppercase tracking-widest bg-indigo-500/15 px-4 py-1.5 rounded-full hidden border border-indigo-500/30" onclick="window.toggleMapView()">
                    Mapa
                </button>
                <div class="relative cursor-pointer hover:scale-110 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    <span class="absolute -top-1 -right-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>
                </div>
            </div>
        </header>

        <!-- NAVEGADOR DE VISTAS -->
        <main class="flex-grow relative overflow-hidden bg-[#0d1117]">

            <!-- VISTA: EXPLORAR (HOME) -->
            <div id="home-view" class="view active p-6 animate-view">
                <div class="mb-8">
                    <h2 class="text-white text-4xl font-black tracking-tight mb-2">Busca ayuda</h2>
                    <p class="text-gray-500 text-sm mb-6 font-semibold uppercase tracking-wider">Expertos verificados en tu ciudad.</p>
                    <div class="relative group">
                        <input type="text" placeholder="¬øQu√© necesitas reparar?" 
                               class="w-full p-5 pl-14 rounded-[2rem] bg-[#161b22] text-white border border-gray-800 focus:outline-none focus:border-indigo-500 transition-all shadow-2xl group-hover:border-gray-700 font-medium">
                        <svg class="absolute left-5 top-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    </div>
                </div>

                <!-- CATEGOR√çAS (SCROLL HORIZONTAL) -->
                <div class="flex gap-4 overflow-x-auto pb-6 no-scrollbar mb-2">
                    <button class="cat-btn flex-shrink-0 px-6 py-3 rounded-2xl bg-[#21262d] border border-gray-800 text-gray-400 text-xs font-black uppercase tracking-widest transition" onclick="window.filterWorkers('Electricista')">Electricistas</button>
                    <button class="cat-btn flex-shrink-0 px-6 py-3 rounded-2xl bg-[#21262d] border border-gray-800 text-gray-400 text-xs font-black uppercase tracking-widest transition" onclick="window.filterWorkers('Plomero')">Plomeros</button>
                    <button class="cat-btn flex-shrink-0 px-6 py-3 rounded-2xl bg-[#21262d] border border-gray-800 text-gray-400 text-xs font-black uppercase tracking-widest transition" onclick="window.filterWorkers('Carpintero')">Carpinteros</button>
                    <button class="cat-btn flex-shrink-0 px-6 py-3 rounded-2xl bg-[#21262d] border border-gray-800 text-gray-400 text-xs font-black uppercase tracking-widest transition" onclick="window.filterWorkers('Alba√±il')">Alba√±iles</button>
                    <button class="cat-btn flex-shrink-0 px-6 py-3 rounded-2xl bg-[#21262d] border border-gray-800 text-gray-400 text-xs font-black uppercase tracking-widest transition" onclick="window.filterWorkers('all')">Todos</button>
                </div>

                <!-- VISTA MAPA (OCULTA POR DEFECTO) -->
                <div id="map-container" class="hidden animate-view mb-8">
                    <div id="map"></div>
                    <div class="bg-indigo-500/10 p-4 rounded-2xl border border-indigo-500/20 mt-4">
                        <p class="text-[11px] text-indigo-400 text-center font-black uppercase tracking-widest">Mostrando profesionales activos en el √°rea</p>
                    </div>
                </div>

                <!-- LISTA DE PROFESIONALES -->
                <div id="worker-list-container">
                    <h3 id="list-title" class="text-white text-[11px] font-black uppercase tracking-[0.3em] mb-6 flex items-center gap-3">
                        <span class="w-3 h-3 bg-indigo-500 rounded-full shadow-[0_0_10px_rgba(99,102,241,0.8)]"></span> Destacados Cerca
                    </h3>
                    <div id="worker-list" class="space-y-5">
                        <!-- Esqueleto de carga visual -->
                        <div class="animate-pulse flex space-x-4 p-6 bg-[#161b22] rounded-[2.5rem] border border-gray-800">
                            <div class="rounded-2xl bg-gray-800 h-16 w-16"></div>
                            <div class="flex-1 space-y-4 py-1">
                                <div class="h-3 bg-gray-800 rounded w-3/4"></div>
                                <div class="h-2 bg-gray-800 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA: PERFIL DETALLADO -->
            <div id="worker-profile-view" class="view p-0 animate-view">
                <div class="relative h-64 bg-gradient-to-br from-indigo-900 via-indigo-700 to-fuchsia-900 p-8 flex items-end overflow-hidden">
                    <div class="absolute inset-0 opacity-30 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]"></div>
                    <button onclick="window.showView('home')" class="absolute top-8 left-8 p-3 bg-black/30 rounded-2xl text-white backdrop-blur-2xl border border-white/10 shadow-2xl z-10 hover:bg-black/50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    
                    <div class="flex items-center gap-6 translate-y-14 z-10">
                        <img id="worker-avatar-profile" class="h-32 w-32 rounded-[2.5rem] border-[10px] border-[#0d1117] object-cover bg-gray-800 shadow-2xl" src="">
                        <div class="mb-8">
                            <h2 id="worker-name-profile" class="text-3xl font-black text-white leading-none mb-2 tracking-tighter">...</h2>
                            <div class="flex items-center gap-3">
                                <p id="worker-oficio-profile" class="text-indigo-400 font-black uppercase tracking-[0.15em] text-[10px]">...</p>
                                <span class="w-1.5 h-1.5 bg-gray-700 rounded-full"></span>
                                <p id="worker-rating-text" class="text-yellow-400 text-xs font-black">‚òÖ 4.9</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-8 mt-16 space-y-10">
                    <!-- Tarjeta de Estad√≠sticas -->
                    <div class="grid grid-cols-3 gap-4 bg-[#161b22] p-6 rounded-[2.5rem] text-center border border-gray-800 shadow-2xl shadow-black/50">
                        <div>
                            <p class="text-white font-black text-xl" id="worker-reviews-count">--</p>
                            <p class="text-[9px] text-gray-600 uppercase font-black tracking-widest">Rese√±as</p>
                        </div>
                        <div class="border-x border-gray-800 px-2">
                            <p class="text-white font-black text-xl" id="worker-distance-profile">-- km</p>
                            <p class="text-[9px] text-gray-600 uppercase font-black tracking-widest">Cerca</p>
                        </div>
                        <div>
                            <p class="text-green-500 font-black text-xl">100%</p>
                            <p class="text-[9px] text-gray-600 uppercase font-black tracking-widest">Confianza</p>
                        </div>
                    </div>

                    <!-- Biograf√≠a -->
                    <div>
                        <h3 class="text-white font-black text-xs uppercase tracking-[0.2em] mb-4 flex items-center gap-3">
                             <div class="p-1.5 bg-indigo-500/20 rounded-lg text-indigo-400">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                             </div> Biograf√≠a Profesional
                        </h3>
                        <p id="worker-bio-profile" class="text-gray-400 text-sm leading-relaxed font-medium">
                            Cargando informaci√≥n del profesional certificado...
                        </p>
                    </div>

                    <!-- Galer√≠a Simulada -->
                    <div>
                        <h3 class="text-white font-black text-xs uppercase tracking-[0.2em] mb-4">Trabajos Recientes</h3>
                        <div class="flex gap-3 overflow-x-auto no-scrollbar">
                            <div class="w-24 h-24 bg-gray-800 rounded-2xl flex-shrink-0 border border-gray-700"></div>
                            <div class="w-24 h-24 bg-gray-800 rounded-2xl flex-shrink-0 border border-gray-700"></div>
                            <div class="w-24 h-24 bg-gray-800 rounded-2xl flex-shrink-0 border border-gray-700"></div>
                        </div>
                    </div>

                    <!-- Botones de Acci√≥n -->
                    <div class="flex flex-col gap-4">
                        <button onclick="window.startChatFromProfile()" class="w-full py-5 bg-indigo-600 text-white font-black rounded-[1.8rem] shadow-2xl shadow-indigo-500/25 active:scale-95 transition-all uppercase tracking-widest text-xs">Iniciar Conversaci√≥n</button>
                        <button class="w-full py-5 bg-[#21262d] text-gray-300 font-bold rounded-[1.8rem] border border-gray-800 active:scale-95 transition-all text-xs uppercase tracking-widest">Pedir Presupuesto Gratis</button>
                    </div>
                </div>
            </div>

            <!-- VISTA: LISTA DE CHATS -->
            <div id="messages-view" class="view p-6 animate-view">
                <h2 class="text-white text-4xl font-black tracking-tighter mb-10">Chats</h2>
                <div id="message-list" class="space-y-5">
                    <!-- Contenido cuando no hay sesi√≥n -->
                    <div class="bg-[#161b22] p-12 rounded-[3rem] border-2 border-dashed border-gray-800 text-center shadow-inner">
                        <div class="w-20 h-20 bg-gray-800/50 rounded-full flex items-center justify-center mx-auto mb-6 border border-gray-700">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        </div>
                        <p class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mb-6 leading-relaxed">Debes iniciar sesi√≥n para<br>gestionar tus mensajes</p>
                        <button onclick="window.openAuthModal()" class="px-8 py-3 bg-indigo-500/10 text-indigo-400 rounded-full text-[10px] font-black uppercase tracking-widest border border-indigo-500/20 hover:bg-indigo-500/20 transition">Ir a Login</button>
                    </div>
                </div>
            </div>

            <!-- VISTA: CHAT INDIVIDUAL (OVERLAY) -->
            <div id="chat-detail-view" class="absolute inset-0 bg-[#0d1117] z-30 hidden flex flex-col animate-view">
                <div class="p-5 bg-[#161b22]/95 backdrop-blur-xl border-b border-gray-800 flex items-center shadow-xl">
                    <button onclick="window.closeChat()" class="text-gray-400 mr-5 p-3 bg-gray-800/40 rounded-2xl hover:bg-gray-800 transition">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><path d="m15 18-6-6 6-6"/></svg>
                    </button>
                    <img id="chat-avatar" class="h-12 w-12 rounded-2xl mr-4 object-cover border border-gray-700 shadow-lg" src="">
                    <div>
                        <h3 id="chat-name" class="text-white font-black text-base leading-none tracking-tight">...</h3>
                        <p class="text-[10px] text-green-500 font-black uppercase tracking-widest mt-1.5 flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span> Activo ahora
                        </p>
                    </div>
                </div>
                <!-- √Årea de mensajes con textura -->
                <div id="chat-messages" class="flex-grow p-6 overflow-y-auto flex flex-col bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
                    <!-- Los mensajes se inyectan aqu√≠ -->
                </div>
                <!-- Entrada de texto -->
                <div class="p-5 bg-[#161b22] flex items-center border-t border-gray-800 shadow-[0_-20px_50px_rgba(0,0,0,0.6)]">
                    <button class="p-3.5 text-gray-500 hover:text-indigo-400 transition transform hover:scale-110"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></button>
                    <input id="chat-input" type="text" placeholder="Escribe un mensaje..." class="flex-grow bg-[#0d1117] text-white rounded-[1.5rem] py-4 px-6 mx-2 focus:outline-none border border-gray-800 focus:border-indigo-500 transition-all font-semibold text-sm shadow-inner">
                    <button onclick="window.sendMessage()" class="bg-indigo-600 p-4 rounded-2xl text-white shadow-2xl shadow-indigo-500/40 active:scale-90 transition-all transform hover:rotate-12"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg></button>
                </div>
            </div>

            <!-- VISTA: MIS TRABAJOS (HISTORIAL) -->
            <div id="jobs-view" class="view p-6 animate-view">
                <h2 class="text-white text-4xl font-black tracking-tighter mb-10">Tareas</h2>
                <div class="space-y-5" id="jobs-list">
                    <!-- Tarjeta de ejemplo de trabajo -->
                    <div class="bg-[#161b22] p-6 rounded-[2.5rem] border border-gray-800 shadow-2xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-yellow-500/5 rounded-full blur-2xl group-hover:bg-yellow-500/10 transition"></div>
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-white font-black text-base tracking-tight mb-1 uppercase">Reparaci√≥n T√©rmica</h4>
                                <p class="text-gray-600 text-[10px] font-black uppercase tracking-widest">ID #AR-89241</p>
                            </div>
                            <span class="px-4 py-1.5 bg-yellow-500/10 text-yellow-500 text-[9px] font-black rounded-full border border-yellow-500/20 shadow-lg uppercase tracking-widest">Pendiente</span>
                        </div>
                        <div class="flex items-center gap-4 py-4 border-y border-gray-800/40">
                            <div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400 font-black text-sm border border-indigo-500/20">JP</div>
                            <div>
                                <p class="text-gray-300 text-xs font-black">Juan P√©rez</p>
                                <p class="text-indigo-400 text-[9px] font-black uppercase tracking-widest mt-0.5">Electricista</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-5">
                            <p class="text-gray-600 text-[10px] font-black uppercase tracking-widest">Ayer ‚Ä¢ 18:30</p>
                            <button class="text-indigo-400 text-[11px] font-black uppercase tracking-[0.2em] hover:text-white transition-all flex items-center gap-2">
                                Gestionar <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="m9 18 6-6-6-6"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA: MI PERFIL / AJUSTES -->
            <div id="settings-view" class="view p-6 animate-view">
                <h2 class="text-white text-4xl font-black tracking-tighter mb-10">Perfil</h2>
                <div id="auth-info" class="bg-gradient-to-br from-indigo-600 via-indigo-700 to-fuchsia-700 rounded-[2.8rem] p-8 mb-10 shadow-3xl shadow-indigo-900/40 relative overflow-hidden group">
                    <div class="absolute -right-12 -top-12 w-48 h-48 bg-white/10 rounded-full blur-3xl group-hover:bg-white/15 transition-all duration-700"></div>
                    <!-- El contenido de esta tarjeta cambia seg√∫n si hay login o no -->
                </div>
                
                <!-- Men√∫ de opciones de configuraci√≥n -->
                <div class="bg-[#161b22] rounded-[2.5rem] border border-gray-800 overflow-hidden divide-y divide-gray-800/50 shadow-2xl">
                    <div class="p-6 flex justify-between items-center text-white text-sm font-black uppercase tracking-widest cursor-pointer hover:bg-gray-800 transition group">
                        <div class="flex items-center gap-5">
                            <div class="p-3 bg-gray-800 rounded-2xl text-indigo-400 group-hover:scale-110 transition shadow-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></div>
                            <span>Notificaciones Push</span>
                        </div>
                        <div class="w-12 h-6 bg-indigo-600 rounded-full relative shadow-inner"><div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full shadow-lg"></div></div>
                    </div>
                    <div class="p-6 flex justify-between items-center text-white text-sm font-black uppercase tracking-widest cursor-pointer hover:bg-gray-800 transition group">
                        <div class="flex items-center gap-5">
                            <div class="p-3 bg-gray-800 rounded-2xl text-emerald-400 group-hover:scale-110 transition shadow-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg></div>
                            <span>Pagos y Facturaci√≥n</span>
                        </div>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" class="text-gray-700"><path d="m9 18 6-6-6-6"/></svg>
                    </div>
                    <div id="sign-out-btn" class="p-6 flex items-center gap-5 text-red-400 text-sm font-black uppercase tracking-widest cursor-pointer hover:bg-red-900/10 transition hidden rounded-b-[2.5rem]" onclick="window.signOutUser()">
                        <div class="p-3 bg-red-900/20 rounded-2xl shadow-lg"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg></div>
                        <span>Cerrar Sesi√≥n</span>
                    </div>
                </div>
                <div class="mt-16 text-center">
                    <p class="text-gray-700 text-[11px] font-black uppercase tracking-[0.4em] mb-2">Arreglados Oficial v2.4</p>
                    <div class="flex justify-center gap-4 text-gray-800 text-[9px] font-bold uppercase tracking-widest">
                        <span>Privacidad</span>
                        <span>Soporte</span>
                        <span>TyC</span>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- MODAL DE AUTENTICACI√ìN (LOGIN/REGISTRO) -->
        <div id="auth-modal" class="fixed inset-0 bg-black/98 z-50 hidden justify-center items-center p-6 backdrop-blur-3xl">
            <div class="bg-[#161b22] p-10 rounded-[3.5rem] w-full max-w-sm border border-gray-800 shadow-[0_50px_100px_rgba(0,0,0,0.8)] relative overflow-hidden">
                <div class="absolute -left-32 -bottom-32 w-80 h-80 bg-indigo-500/15 rounded-full blur-[100px]"></div>
                <div class="text-center mb-10 relative">
                    <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 via-purple-600 to-pink-500 rounded-[2rem] mx-auto mb-6 flex items-center justify-center text-white font-black text-4xl shadow-2xl shadow-indigo-500/30">A</div>
                    <h3 class="text-white text-3xl font-black tracking-tighter mb-2 leading-none">Bienvenido</h3>
                    <p class="text-gray-500 text-sm font-semibold tracking-wide uppercase">Accede a soluciones reales</p>
                </div>
                
                <p id="auth-error-message" class="text-[10px] text-red-400 mb-6 hidden bg-red-950/30 p-4 rounded-2xl border border-red-900/50 text-center font-black uppercase tracking-widest"></p>
                
                <div class="space-y-4 relative">
                    <div class="relative">
                        <input id="auth-email" type="email" placeholder="Email" class="w-full p-5 pl-14 rounded-2xl bg-[#0d1117] text-white border border-gray-800 focus:border-indigo-500 transition-all outline-none font-bold placeholder:text-gray-700">
                        <svg class="absolute left-5 top-5 text-gray-700" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                    </div>
                    <div class="relative">
                        <input id="auth-password" type="password" placeholder="Password" class="w-full p-5 pl-14 rounded-2xl bg-[#0d1117] text-white border border-gray-800 focus:border-indigo-500 transition-all outline-none font-bold placeholder:text-gray-700">
                        <svg class="absolute left-5 top-5 text-gray-700" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                </div>

                <div class="mt-10 flex flex-col gap-4 relative">
                    <button id="login-button" onclick="window.handleAuth(true)" class="w-full py-5 bg-indigo-600 text-white font-black rounded-3xl shadow-2xl shadow-indigo-500/30 active:scale-95 transition-all uppercase tracking-[0.2em] text-xs">Entrar</button>
                    <button id="register-button" onclick="window.handleAuth(false)" class="w-full py-5 bg-[#21262d] text-white font-black rounded-3xl border border-gray-800 active:scale-95 transition-all uppercase tracking-[0.2em] text-[10px] hover:bg-gray-800">Registrarse</button>
                </div>
                
                <button onclick="window.closeAuthModal()" class="w-full mt-8 text-gray-700 text-[11px] font-black uppercase tracking-[0.4em] hover:text-gray-500 transition-all">Cerrar</button>
            </div>
        </div>

        <!-- BARRA DE NAVEGACI√ìN INFERIOR (FOOTER) -->
        <footer class="bg-[#161b22]/95 backdrop-blur-2xl border-t border-gray-800 p-3 flex justify-around items-center z-40 shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
            <button class="nav-button active flex flex-col items-center p-3 transition-all duration-300 transform" data-view="home" onclick="window.showView('home')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-[9px] font-black mt-2 uppercase tracking-tighter">Explorar</span>
            </button>
            <button class="nav-button flex flex-col items-center p-3 transition-all duration-300 text-gray-600 transform" data-view="messages" onclick="window.showView('messages')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <span class="text-[9px] font-black mt-2 uppercase tracking-tighter">Chats</span>
            </button>
            <button class="nav-button flex flex-col items-center p-3 transition-all duration-300 text-gray-600 transform" data-view="jobs" onclick="window.showView('jobs')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
                <span class="text-[9px] font-black mt-2 uppercase tracking-tighter">Tareas</span>
            </button>
            <button class="nav-button flex flex-col items-center p-3 transition-all duration-300 text-gray-600 transform" data-view="settings" onclick="window.showView('settings')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-[9px] font-black mt-2 uppercase tracking-tighter">Perfil</span>
            </button>
        </footer>
    </div>

    <!-- L√ìGICA DE FIREBASE Y FUNCIONALIDAD DE LA APP -->
    <script type="module">
        // Importaci√≥n de m√≥dulos oficiales de Firebase v11
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, limit, setDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACI√ìN PROPORCIONADA POR EL ENTORNO
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // INICIALIZACI√ìN DE SERVICIOS
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // VARIABLES DE ESTADO GLOBALES
        window.currentWorkerData = null;
        window.markers = [];
        window.isAuthAppReady = false; 
        window.map = null;

        // --- MANEJO DE VISTAS Y NAVEGACI√ìN ---
        window.showView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.toggle('active', v.id === viewId + '-view'));
            document.querySelectorAll('.nav-button').forEach(btn => {
                const isActive = btn.dataset.view === viewId;
                btn.classList.toggle('text-indigo-400', isActive);
                btn.classList.toggle('active', isActive);
                btn.classList.toggle('text-gray-600', !isActive);
            });
            
            // Actualizaci√≥n de T√≠tulos e Interfaz
            const viewTitles = { 
                home: 'EXPLORAR', 
                messages: 'MIS CHATS', 
                jobs: 'MIS TAREAS', 
                settings: 'MI CUENTA', 
                'worker-profile': 'PERFIL PROFESIONAL' 
            };
            document.getElementById('header-title').textContent = viewTitles[viewId] || 'ARREGLADOS';
            
            // Mostrar bot√≥n de mapa solo en Home
            document.getElementById('map-toggle-btn').classList.toggle('hidden', viewId !== 'home');
            
            // Refrescar mapa si se vuelve a Home
            if (viewId === 'home' && window.map) {
                setTimeout(() => window.map.invalidateSize(), 150);
            }
        };

        // --- SISTEMA DE MAPAS (LEAFLET) ---
        window.toggleMapView = () => {
            const container = document.getElementById('map-container');
            const list = document.getElementById('worker-list-container');
            const btn = document.getElementById('map-toggle-btn');
            
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                list.classList.add('hidden');
                btn.textContent = "Lista";
                if (!window.map) initMap();
                setTimeout(() => window.map.invalidateSize(), 200);
            } else {
                container.classList.add('hidden');
                list.classList.remove('hidden');
                btn.textContent = "Mapa";
            }
        };

        function initMap() {
            if (window.map) return;
            // Centro inicial en Buenos Aires
            window.map = L.map('map', { zoomControl: false }).setView([-34.6037, -58.3816], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                attribution: '&copy; CartoDB',
                maxZoom: 19 
            }).addTo(map);
        }

        // --- SISTEMA DE AUTENTICACI√ìN ---
        window.openAuthModal = () => {
            const modal = document.getElementById('auth-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };
        
        window.closeAuthModal = () => {
            const modal = document.getElementById('auth-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('auth-error-message').classList.add('hidden');
        };

        window.handleAuth = async (isLogin) => {
            if (!auth) return;
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorEl = document.getElementById('auth-error-message');
            
            if (!email || !password) return;
            errorEl.classList.add('hidden');

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
                window.closeAuthModal();
            } catch (e) {
                console.error("Auth Error:", e);
                let cleanError = e.code ? e.code.split('/')[1].replace(/-/g, ' ') : 'Error desconocido';
                errorEl.textContent = "FALLO: " + cleanError;
                errorEl.classList.remove('hidden');
            }
        };

        window.signOutUser = () => signOut(auth);

        // --- GESTI√ìN DE DATOS DE TRABAJADORES (FIRESTORE) ---
        window.filterWorkers = (category) => {
            document.getElementById('list-title').textContent = category === 'all' ? 'Destacados cerca de ti' : 'Resultados: ' + category;
            
            // Actualizar estado visual de los botones de categor√≠a
            document.querySelectorAll('.cat-btn').forEach(btn => {
                const isActive = btn.textContent.toLowerCase().includes(category.toLowerCase()) || (category === 'all' && btn.textContent === 'Todos');
                btn.classList.toggle('active', isActive);
            });
            
            fetchWorkers(category);
        };

        let currentWorkersListener = null;

        function fetchWorkers(category = 'all') {
            // Regla: No ejecutar si no hay usuario autenticado (aunque sea an√≥nimo)
            if (!auth.currentUser) return;
            
            // Detener listener anterior si existe
            if (currentWorkersListener) currentWorkersListener();

            // Ruta estricta de colecci√≥n (Regla 1)
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'workers');
            
            // Consulta simple (Regla 2: EvitarOrderBy/Complex)
            let q = category === 'all' ? query(colRef, limit(12)) : query(colRef, where("oficio", "==", category));

            currentWorkersListener = onSnapshot(q, (snap) => {
                const container = document.getElementById('worker-list');
                container.innerHTML = snap.empty ? '<div class="p-16 text-center text-gray-700 font-black uppercase text-[10px] tracking-[0.4em]">Sin resultados en tu zona</div>' : '';
                
                // Limpiar marcadores antiguos del mapa
                if (window.map) window.markers.forEach(m => window.map.removeLayer(m));
                window.markers = [];

                snap.forEach(docSnap => {
                    const w = docSnap.data();
                    const initials = w.nombre.split(' ').map(n => n[0]).join('');
                    
                    // Renderizaci√≥n de la tarjeta en la lista
                    container.innerHTML += `
                        <div class="flex items-center bg-[#161b22] p-6 rounded-[2.5rem] mb-5 border border-gray-800 hover:border-indigo-500 transition-all cursor-pointer shadow-xl active:scale-[0.97] group" onclick="window.openWorkerProfile('${docSnap.id}')">
                            <div class="h-16 w-16 rounded-[1.2rem] bg-gradient-to-br from-indigo-900/40 to-purple-900/40 text-indigo-400 flex items-center justify-center font-black text-2xl mr-6 border border-indigo-900/30 group-hover:scale-105 transition-transform">${initials}</div>
                            <div class="flex-grow">
                                <p class="text-white font-black text-base tracking-tight mb-1">${w.nombre}</p>
                                <p class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.25em]">${w.oficio}</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center justify-end gap-1.5 mb-2">
                                    <span class="text-yellow-400 text-sm font-black">‚òÖ</span>
                                    <span class="text-white text-[11px] font-black">4.9</span>
                                </div>
                                <p class="text-gray-600 text-[9px] font-black uppercase tracking-widest">${w.distancia} km</p>
                            </div>
                        </div>`;
                    
                    // Agregar marcador al mapa si hay coordenadas
                    if (window.map && w.lat && w.lng) {
                        const m = L.marker([w.lat, w.lng]).addTo(window.map).bindPopup(`<div class="p-2 text-center"><b class="text-indigo-600">${w.nombre}</b><br><span class="text-[9px] uppercase font-bold">${w.oficio}</span></div>`);
                        window.markers.push(m);
                    }
                });
            }, (error) => {
                console.error("Firestore Error:", error);
            });
        }

        window.openWorkerProfile = async (id) => {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'workers', id);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const data = snap.data();
                window.currentWorkerData = data;
                
                // Actualizar UI del perfil
                document.getElementById('worker-name-profile').textContent = data.nombre;
                document.getElementById('worker-oficio-profile').textContent = data.oficio;
                document.getElementById('worker-avatar-profile').src = `https://placehold.co/240x240/4f46e5/ffffff?text=${data.nombre[0]}`;
                document.getElementById('worker-distance-profile').textContent = data.distancia + " km";
                document.getElementById('worker-reviews-count').textContent = Math.floor(Math.random() * 150) + 40;
                document.getElementById('worker-bio-profile').textContent = data.bio || `Profesional verificado especializado en ${data.oficio}. Ofrezco soluciones r√°pidas, presupuesto sin cargo y garant√≠a total en materiales y mano de obra.`;
                
                window.showView('worker-profile');
            }
        };

        // --- SISTEMA DE CHAT SIMULADO ---
        window.startChatFromProfile = () => {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                window.openAuthModal();
                return;
            }
            const name = window.currentWorkerData?.nombre || "Profesional";
            document.getElementById('chat-name').textContent = name;
            document.getElementById('chat-avatar').src = `https://placehold.co/100x100/6366f1/ffffff?text=${name[0]}`;
            
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = `
                <div class="chat-bubble chat-received">¬°Hola! Soy ${name}. Vi que necesitas un profesional en ${window.currentWorkerData?.oficio || 'el rubro'}. ¬øC√≥mo puedo ayudarte hoy?</div>
                <div class="chat-bubble chat-received">Si quieres, puedo pasarte un presupuesto aproximado si me comentas un poco m√°s sobre el trabajo.</div>
            `;
            
            document.getElementById('chat-detail-view').classList.remove('hidden');
        };

        window.closeChat = () => document.getElementById('chat-detail-view').classList.add('hidden');

        window.sendMessage = () => {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML += `<div class="chat-bubble chat-sent">${msg}</div>`;
            input.value = '';
            
            // Efecto de autoscroll
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 100);
            
            // Simulaci√≥n de respuesta despu√©s de 1 segundo
            setTimeout(() => {
                chatBox.innerHTML += `<div class="chat-bubble chat-received">Recibido. D√©jame consultarlo y te respondo en unos minutos. ¬°Gracias!</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }, 1500);
        };

        // --- INICIALIZACI√ìN DE LA APP (REGLA 3) ---
        async function startApp() {
            try {
                // Paso 1: Autenticaci√≥n obligatoria antes de cualquier query
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                window.isAuthAppReady = true;
                
                // Paso 2: Poblado de datos iniciales si la base est√° vac√≠a
                await seedInitialData();
                
                // Paso 3: Carga inicial de trabajadores
                fetchWorkers();
                
            } catch (err) {
                console.error("Critical Start Error:", err);
            }
        }

        async function seedInitialData() {
            if (!auth.currentUser) return;
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'workers');
            const snap = await getDocs(colRef);
            
            // Si no hay datos, creamos unos cuantos profesionales de ejemplo
            if (snap.empty) {
                const dummyWorkers = [
                    { nombre: "Juan P√©rez", oficio: "Electricista", distancia: 1.2, lat: -34.6037, lng: -58.3816, bio: "Especialista en cortocircuitos y tableros industriales. Matr√≠cula vigente." },
                    { nombre: "Mar√≠a G√≥mez", oficio: "Plomero", distancia: 2.5, lat: -34.5997, lng: -58.4000, bio: "Reparaci√≥n de fugas, destapes y termotanques. Atenci√≥n 24hs urgencias." },
                    { nombre: "Roberto D√≠az", oficio: "Carpintero", distancia: 3.1, lat: -34.6200, lng: -58.3700, bio: "Muebles a medida, restauraci√≥n de puertas y colocaci√≥n de pisos flotantes." },
                    { nombre: "Ana L√≥pez", oficio: "Electricista", distancia: 0.8, lat: -34.6150, lng: -58.3900, bio: "Instalaciones domiciliarias nuevas y colocaci√≥n de luminarias LED." },
                    { nombre: "Carlos Tech", oficio: "Alba√±il", distancia: 4.2, lat: -34.5800, lng: -58.4200, bio: "Construcci√≥n en seco, revoques y colocaci√≥n de cer√°micas de alta calidad." },
                    { nombre: "Sof√≠a Arreglos", oficio: "Alba√±il", distancia: 1.7, lat: -34.5900, lng: -58.3850, bio: "Pintura de obra, impermeabilizaci√≥n de techos y terminaciones finas." }
                ];
                for (const worker of dummyWorkers) {
                    // Usamos un ID aleatorio √∫nico
                    await setDoc(doc(colRef, crypto.randomUUID()), worker);
                }
                console.log("Base de datos inicializada con √©xito.");
            }
        }

        // Listener de cambios de autenticaci√≥n para actualizar la interfaz
        onAuthStateChanged(auth, (user) => {
            const infoContainer = document.getElementById('auth-info');
            const signoutBtn = document.getElementById('sign-out-btn');
            
            if (user && !user.isAnonymous) {
                // Usuario logueado con Email
                infoContainer.innerHTML = `
                    <div class="flex items-center gap-6 relative z-10">
                        <div class="w-20 h-20 bg-white/20 rounded-[1.8rem] flex items-center justify-center font-black text-3xl backdrop-blur-2xl border border-white/30 shadow-2xl">${user.email ? user.email[0].toUpperCase() : 'U'}</div>
                        <div>
                            <p class="text-white font-black text-2xl tracking-tighter leading-none mb-2">Mi Cuenta</p>
                            <p class="text-indigo-100 text-[10px] font-bold uppercase tracking-[0.2em] opacity-80 truncate w-48">${user.email || 'Email Registrado'}</p>
                        </div>
                    </div>
                    <div class="mt-8 flex gap-3 relative z-10">
                        <span class="px-4 py-1.5 bg-green-500/20 text-green-300 text-[10px] font-black rounded-full border border-green-500/30 uppercase tracking-widest shadow-lg">Verificado</span>
                        <span class="px-4 py-1.5 bg-yellow-500/20 text-yellow-300 text-[10px] font-black rounded-full border border-yellow-500/30 uppercase tracking-widest shadow-lg">Premium üíé</span>
                    </div>`;
                signoutBtn.classList.remove('hidden');
                
                // Actualizar la lista de mensajes (Simulada para usuario logueado)
                document.getElementById('message-list').innerHTML = `
                    <div class="bg-[#161b22] p-6 rounded-[2.8rem] border border-gray-800 flex items-center gap-5 cursor-pointer hover:border-indigo-500 transition-all shadow-2xl group active:scale-95" onclick="window.currentWorkerData={nombre:'Juan P√©rez', oficio:'Electricista'}; window.startChatFromProfile()">
                        <div class="h-16 w-16 rounded-[1.2rem] bg-indigo-600 flex items-center justify-center font-black text-white text-xl shadow-lg group-hover:rotate-6 transition">JP</div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-white font-black text-base tracking-tight">Juan P√©rez</h4>
                                <span class="text-[9px] text-gray-600 font-bold uppercase tracking-widest">Hace 2 min</span>
                            </div>
                            <p class="text-gray-500 text-xs font-medium truncate w-44">¬øTe parece bien si paso ma√±ana a las 10:00?</p>
                        </div>
                        <div class="w-3 h-3 bg-indigo-500 rounded-full shadow-[0_0_10px_rgba(99,102,241,0.6)]"></div>
                    </div>
                `;
            } else {
                // Usuario An√≥nimo
                infoContainer.innerHTML = `
                    <div class="relative z-10">
                        <h4 class="text-white font-black text-3xl tracking-tighter mb-4 leading-tight">√önete a la<br>comunidad</h4>
                        <p class="text-indigo-100 text-sm font-medium mb-8 opacity-90 leading-relaxed">Crea tu cuenta gratis para chatear con expertos y guardar tus presupuestos.</p>
                        <button onclick="window.openAuthModal()" class="w-full py-5 bg-white text-indigo-700 font-black rounded-[1.8rem] shadow-2xl active:scale-95 transition-transform uppercase tracking-[0.2em] text-[10px]">CREAR MI CUENTA AHORA</button>
                    </div>`;
                signoutBtn.classList.add('hidden');
            }
            
            // Recargar datos cuando el estado de auth cambia
            if (user) fetchWorkers();
        });

        // ARRANCAR APLICACI√ìN
        startApp();

    </script>
</body>
</html>